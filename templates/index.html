<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mock Media Settings — Dashboard</title>
  <style>
    :root {
      --bg:#f6f8fa; --card:#fff; --muted:#6b7280;
      --accent:#2563eb; --mono: ui-monospace, SFMono-Regular, Menlo, Monaco,
      'Roboto Mono', 'Courier New', monospace;
    }
    body {
      margin:0; padding:20px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg); color:#111827;
    }
    .container { max-width:1200px; margin:0 auto; }
    header { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:16px; }
    h1 { margin:0; font-size:1.25rem; }
    .sub { color:var(--muted); font-size:0.9rem; }
    code { font-family:var(--mono); font-size:0.8rem; }

    .grid { display:grid; gap:12px; grid-template-columns: 1.3fr 1fr; align-items:flex-start; }
    .card {
      background:var(--card);
      border:1px solid #e6edf3;
      border-radius:8px;
      padding:12px;
      box-shadow:0 1px 0 rgba(16,24,40,0.02);
    }
    pre {
      background:#0b1220; color:#e6eef8;
      padding:12px; border-radius:6px;
      overflow:auto; font-family:var(--mono);
      font-size:13px; line-height:1.4; max-height:420px;
    }
    label { display:block; margin-top:8px; font-size:0.9rem; }
    textarea, input, select {
      width:100%; box-sizing:border-box;
      font-family:var(--mono); font-size:13px;
      padding:8px; border-radius:6px;
      border:1px solid #e6edf3;
    }
    .btn {
      background:var(--accent); color:white;
      padding:8px 12px; border-radius:6px;
      cursor:pointer; border:none; font-weight:600;
      font-size:0.9rem;
    }
    .btn.secondary { background:#111827; }
    .btn[disabled] { opacity:0.5; cursor:not-allowed; }
    .row { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .small { font-size:0.85rem; color:var(--muted); }
    #state-summary {
      min-height:100px; padding:8px;
      border-radius:6px; border:1px solid #e6edf3;
      background:#f9fafb;
      font-family:var(--mono); font-size:13px;
      white-space:pre-wrap;
    }
    .pill {
      display:inline-flex; align-items:center; gap:4px;
      padding:2px 6px; border-radius:999px;
      background:#e5e7eb; font-size:0.75rem;
    }
    .pill.ok { background:#dcfce7; color:#14532d; }
    .pill.failed { background:#fee2e2; color:#991b1b; }
    .pill.partial { background:#fef3c7; color:#92400e; }
    .tag {
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:0.7rem;
      background:#e5e7eb;
      margin-right:4px;
    }
    .tag-aircraft { background:#dbeafe; color:#1d4ed8; }
    .aircraft-list {
      max-height:120px;
      overflow:auto;
      margin-top:6px;
      border-radius:6px;
      border:1px solid #e5e7eb;
      padding:4px;
      background:#f9fafb;
      font-family:var(--mono);
      font-size:0.8rem;
    }
    .aircraft-row {
      display:flex;
      justify-content:space-between;
      padding:2px 4px;
    }
    .aircraft-row span.id { font-weight:600; }
    .aircraft-row span.lva { color:var(--muted); }
    .aircraft-row button {
      font-size:0.7rem;
      padding:2px 6px;
    }
    .flex-between {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>Mock Media Settings — Dashboard</h1>
      <div class="sub">
        Headend base URL:
        <code>{{ aircraft_base_url }}</code>
        {% if default_aircraft_id %}
          · Default aircraft:
          <code>{{ default_aircraft_id }}</code>
        {% else %}
          · <span style="color:#b91c1c;font-weight:600">No DEFAULT_AIRCRAFT_ID configured</span>
        {% endif %}
      </div>
      <div class="sub small">
        This UI sends FULL/PATCH/ROLLBACK to one or more aircraft via the multi-aircraft rollback service.
      </div>
    </div>
    <div class="small" id="headend-health">
      Headend: <span class="pill" id="headend-pill">checking…</span>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <div>
      <div class="card">
        <div class="flex-between">
          <h3 style="margin:0">Target Aircraft</h3>
          <button class="btn secondary" style="padding:4px 8px;font-size:0.8rem" onclick="reloadAircraftList()">
            Refresh list
          </button>
        </div>

        <div class="small" style="margin-top:4px">
          Choose which aircraft to target. You can send to a single aircraft or multiple.
        </div>

        <label for="aircraft-mode">Selection mode</label>
        <select id="aircraft-mode" onchange="onAircraftModeChange()">
          <option value="single">Single aircraft</option>
          <option value="multiple">Multiple aircraft</option>
        </select>

        <label for="aircraft-select">Available aircraft (from headend)</label>
        <select id="aircraft-select" multiple size="4" onchange="syncSelectionFromList()">
          <!-- options populated via JS -->
        </select>

        <div class="small" style="margin-top:4px">
          <strong>Tip:</strong> Use Ctrl/⌘ + click to select multiple aircraft when in "Multiple" mode.
        </div>

        <label for="aircraft-ids-input">Aircraft IDs (comma-separated)</label>
        <input id="aircraft-ids-input" type="text" placeholder="e.g. A1,A2,A3" onblur="syncSelectionFromInput()" />

        <div class="small" style="margin-top:4px">
          If left empty, the backend will fall back to <code>DEFAULT_AIRCRAFT_ID</code> if configured.
        </div>

        <div class="aircraft-list" id="aircraft-list-panel">
          Loading aircraft list…
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Current Broadcast Summary</h3>
        <div id="state-summary">Loading…</div>
        <div class="row">
          <button class="btn" onclick="refreshState()">Refresh summary</button>
          <button class="btn secondary" onclick="fetchHistory()">Show history</button>
        </div>
        <div id="initial-warning" class="small" style="color:#b91c1c;font-weight:600">
          Initial FULL (v1+) required before PATCH or ROLLBACK.
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Send PATCH</h3>
        <div class="small">
          Payload will be sent to the aircraft IDs selected above.
          Routing fields (<code>aircraft_id</code>/<code>aircraft_ids</code>) are added automatically.
        </div>
        <textarea id="patch-json" rows="7"></textarea>
        <div class="row">
          <button class="btn" id="btn-send-patch" onclick="sendPatch()" disabled>
            Send PATCH
          </button>
          <button class="btn secondary" onclick="fillExamplePatch()">Example</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Send FULL snapshot</h3>
        <div class="small">
          FULL replaces state on all selected aircraft. Recommended before first PATCH.
        </div>
        <textarea id="full-json" rows="7"></textarea>
        <div class="row">
          <button class="btn" onclick="sendFull()">Send FULL</button>
          <button class="btn secondary" onclick="fillExampleFull()">Example</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Send ROLLBACK</h3>
        <select id="rollback-target">
          <option value="lva">LVA — Last Version Active</option>
          <option value="lkg">LKG — Last Known Good</option>
          <option value="auto">AUTO — Automatic 2 Tier</option>
        </select>
        <div class="row">
          <button class="btn" id="btn-send-rollback" onclick="sendRollback()" disabled>
            Send ROLLBACK
          </button>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card">
        <div class="flex-between">
          <h3 style="margin:0">Per-aircraft State</h3>
          <select id="state-aircraft-select" onchange="renderAircraftState()">
            <!-- populated with same IDs as aircraft list -->
          </select>
        </div>
        <div class="small" style="margin-top:4px">
          Shows the state for a single aircraft (/api/aircraft_state?aircraft_id=&lt;id&gt;).
        </div>
        <pre id="currentState">None</pre>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Activity / Response</h3>
        <pre id="activity">Idle</pre>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Diagnostics & History</h3>
        <div class="row">
          <button class="btn" onclick="pingHeadend()">Ping headend</button>
          <button class="btn" onclick="pingSelectedAircraft()">Ping selected aircraft</button>
          <button class="btn secondary" onclick="fetchHistory()">Load history</button>
        </div>
        <div id="history-list" style="margin-top:12px; max-height:220px; overflow:auto;"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- small helpers ---------- */
function pretty(o) {
  return JSON.stringify(o, null, 2);
}

async function fetchJson(path, opts) {
  const r = await fetch(path, opts);
  const t = await r.text();
  try { return { ok:r.ok, json:JSON.parse(t), status:r.status }; }
  catch { return { ok:r.ok, text:t, status:r.status }; }
}

function parseAndPrettify(id) {
  const el = document.getElementById(id);
  const obj = JSON.parse(el.value);
  el.value = JSON.stringify(obj, null, 2);
  return obj;
}

/* ---------- aircraft selection state ---------- */
let knownAircraft = {}; // { id: { id, lva, ... } }

function getSelectedAircraftIds() {
  const mode = document.getElementById('aircraft-mode').value;
  const raw = document.getElementById('aircraft-ids-input').value.trim();
  let ids = [];

  if (raw) {
    ids = raw.split(',').map(s => s.trim()).filter(Boolean);
  } else {
    // fall back to <select> current selection
    const sel = document.getElementById('aircraft-select');
    const selected = Array.from(sel.options).filter(o => o.selected).map(o => o.value);
    ids = selected;
  }

  // de-dup
  ids = Array.from(new Set(ids));

  if (mode === 'single' && ids.length > 1) {
    ids = ids.slice(0, 1);
  }

  return ids;
}

function onAircraftModeChange() {
  const mode = document.getElementById('aircraft-mode').value;
  const sel = document.getElementById('aircraft-select');
  if (mode === 'single') {
    // ensure only one selected in UI
    const first = sel.options[0];
    Array.from(sel.options).forEach(o => o.selected = false);
    if (first) first.selected = true;
    syncSelectionFromList();
  }
}

function syncSelectionFromList() {
  const sel = document.getElementById('aircraft-select');
  const ids = Array.from(sel.options).filter(o => o.selected).map(o => o.value);
  document.getElementById('aircraft-ids-input').value = ids.join(',');
  // keep the detail state selector in sync
  populateStateAircraftSelect(ids.length ? ids : Object.keys(knownAircraft));
}

function syncSelectionFromInput() {
  const rawIds = getSelectedAircraftIds();
  const sel = document.getElementById('aircraft-select');
  Array.from(sel.options).forEach(o => {
    o.selected = rawIds.includes(o.value);
  });
  populateStateAircraftSelect(rawIds.length ? rawIds : Object.keys(knownAircraft));
}

/* ---------- example payloads ---------- */
async function fillExamplePatch() {
  try {
    const response = await fetch('/static/resource/examplePatch.json');
    const data = await response.json();
    document.getElementById('patch-json').value = JSON.stringify(data, null, 2);
  } catch {
    document.getElementById('patch-json').value = pretty({
      version: 2,
      prev: 1,
      changes: { campaignA_priority: 85 }
    });
  }
}

async function fillExampleFull() {
  try {
    const response = await fetch('/static/resource/exampleFull.json');
    const data = await response.json();
    document.getElementById('full-json').value = JSON.stringify(data, null, 2);
  } catch {
    document.getElementById('full-json').value = pretty({
      version: 1,
      data: {
        campaignA_priority: 70,
        campaignB_routes: []
      }
    });
  }
}

/* ---------- API helpers: build body with aircraft ids ---------- */
function withAircraftRouting(basePayload) {
  const ids = getSelectedAircraftIds();
  const body = Object.assign({}, basePayload);
  if (ids.length === 1) {
    body.aircraft_id = ids[0];
  } else if (ids.length > 1) {
    body.aircraft_ids = ids;
  }
  return body;
}

/* ---------- actions ---------- */
async function sendPatch() {
  let obj; try { obj = parseAndPrettify('patch-json'); }
  catch { return alert('Invalid JSON in PATCH payload'); }

  const body = withAircraftRouting(obj);

  const res = await fetchJson('/api/send_patch', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  renderActivity(res);
  refreshState();
  renderAircraftState();
}

async function sendFull() {
  let obj; try { obj = parseAndPrettify('full-json'); }
  catch { return alert('Invalid JSON in FULL payload'); }

  const body = withAircraftRouting(obj);

  const res = await fetchJson('/api/send_full', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  renderActivity(res);
  refreshState();
  renderAircraftState();
}

async function sendRollback() {
  const target = document.getElementById('rollback-target').value;
  const body = withAircraftRouting({ target });

  const res = await fetchJson('/api/send_rollback', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  renderActivity(res);
  refreshState();
  renderAircraftState();
}

/* ---------- diagnostics ---------- */
async function pingHeadend() {
  const res = await fetchJson('/api/headend_ping');
  renderActivity(res);
  updateHeadendPill(res);
}

async function pingSelectedAircraft() {
  const ids = getSelectedAircraftIds();
  let id = null;
  if (ids.length) {
    id = ids[0];
  } else if (Object.keys(knownAircraft).length) {
    id = Object.keys(knownAircraft)[0];
  }
  const url = id ? `/api/aircraft_ping?aircraft_id=${encodeURIComponent(id)}` : '/api/aircraft_ping';
  const res = await fetchJson(url);
  renderActivity(res);
}

/* ---------- rendering ---------- */
function renderActivity(res) {
  document.getElementById('activity').textContent =
    res.json ? pretty(res.json) : res.text;
}

async function renderAircraftState() {
  const sel = document.getElementById('state-aircraft-select');
  let id = sel.value;
  if (!id) {
    const ids = getSelectedAircraftIds();
    if (ids.length) id = ids[0];
  }
  const url = id ? `/api/aircraft_state?aircraft_id=${encodeURIComponent(id)}` : '/api/aircraft_state';
  const res = await fetchJson(url);
  if (!res.json) return;
  // backend returns { aircraft_id, result: {...} }
  const payload = res.json.result ? res.json.result.response : res.json;
  document.getElementById('currentState').textContent = pretty(payload);
}

function renderStateSummary(state) {
  const s = document.getElementById('state-summary');
  if (!state.history?.length) {
    s.textContent = 'No broadcasts yet.';
    return;
  }
  const h = state.history[0];
  const status = h.status || 'unknown';
  s.textContent =
    `Broadcasts: ${state.history.length}\n` +
    `Last: ${h.type} #${h.id}\nStatus: ${status}\nTime: ${h.timestamp}`;
}

function updateControls(state) {
  const hasFull = state.history?.some(h => h.type === 'FULL');
  document.getElementById('btn-send-patch').disabled = !hasFull;
  document.getElementById('btn-send-rollback').disabled = !hasFull;
  document.getElementById('initial-warning').style.display =
    hasFull ? 'none' : 'block';
}

async function fetchHistory() {
  const res = await fetchJson('/api/history');
  if (!res.json) return;
  const list = document.getElementById('history-list');
  list.innerHTML = '';
  res.json.history.forEach(h => {
    const d = document.createElement('div');
    d.style.padding = '4px 0';
    d.style.borderBottom = '1px solid #e5e7eb';
    d.style.cursor = 'pointer';

    const perAircraft = h.remote_by_aircraft || {};
    const ids = Object.keys(perAircraft);
    const label = document.createElement('div');
    label.textContent = `${h.timestamp} · ${h.type} #${h.id} · ${h.status}`;

    const tags = document.createElement('div');
    if (ids.length) {
      ids.forEach(id => {
        const span = document.createElement('span');
        span.className = 'tag tag-aircraft';
        const ok = perAircraft[id]?.result?.ok;
        const suffix = ok === true ? '✓' : (ok === false ? '✕' : '?');
        span.textContent = `${id} ${suffix}`;
        tags.appendChild(span);
      });
    }

    d.onclick = () => {
      document.getElementById('activity').textContent = pretty(h);
    };

    d.appendChild(label);
    d.appendChild(tags);
    list.appendChild(d);
  });
}

async function refreshState() {
  const res = await fetchJson('/api/state');
  if (!res.json) return;
  renderStateSummary(res.json);
  updateControls(res.json);
}

/* ---------- aircraft list rendering ---------- */
function renderAircraftListResult(result) {
  const panel = document.getElementById('aircraft-list-panel');
  // `result` is the body from the headend /aircraft endpoint:
  //   { ok: bool, aircraft: { <id>: { id, lva, ... }, ... } }
  if (!result.ok || !result.aircraft) {
    panel.textContent = 'Unable to load aircraft list.';
    return;
  }
  const aircraft = result.aircraft || {};
  knownAircraft = aircraft;

  const sel = document.getElementById('aircraft-select');
  sel.innerHTML = '';
  Object.keys(aircraft).sort().forEach(id => {
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = id;
    sel.appendChild(opt);
  });

  // detail state selector gets same ids
  populateStateAircraftSelect(Object.keys(aircraft));

  const lines = [];
  Object.entries(aircraft).forEach(([id, info]) => {
    const hasLvaValue = info.lva !== undefined && info.lva !== null;
    const lva = hasLvaValue ? `LVA: ${info.lva}` : '';
    const lkg = info.lkg !== undefined && info.lkg !== null ? `LKG: ${info.lkg}` : '';
    const active = info.active !== undefined && info.active !== null ? `Active: ${info.active}` : '';
    const details = [lva, lkg, active].filter(Boolean).join(' · ');
    lines.push(
      `<div class="aircraft-row">` +
        `<span>` +
          `<span class="id">${id}</span>` +
        `</span>` +
        `<span class="lva">${details || 'No details'}</span>` +
      `</div>`
    );
  });
  if (!lines.length) {
    panel.textContent = 'No aircraft reported by headend yet.';
  } else {
    panel.innerHTML = lines.join('');
  }
}


function populateStateAircraftSelect(ids) {
  const sel = document.getElementById('state-aircraft-select');
  const current = sel.value;
  sel.innerHTML = '';
  ids.sort().forEach(id => {
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = id;
    sel.appendChild(opt);
  });
  if (ids.includes(current)) {
    sel.value = current;
  } else if (ids.length) {
    sel.value = ids[0];
  }
}

async function reloadAircraftList() {
  const res = await fetchJson('/api/aircraft');
  if (!res.json) {
    document.getElementById('aircraft-list-panel').textContent = 'Error fetching aircraft list.';
    return;
  }
  // res.json is wrapper: { ok, status_code, response: { ok, aircraft:{...}} }
  const inner = res.json.response || res.json;
  renderAircraftListResult(inner);
}

/* ---------- headend health ---------- */
function updateHeadendPill(res) {
  const pill = document.getElementById('headend-pill');
  if (!res.json) {
    pill.textContent = 'unreachable';
    pill.className = 'pill failed';
    return;
  }
  const ok = res.json.ok;
  const count = res.json.response && res.json.response.aircraft_count;
  if (ok) {
    pill.textContent = typeof count === 'number'
      ? `ok · aircraft=${count}`
      : 'ok';
    pill.className = 'pill ok';
  } else {
    pill.textContent = 'error';
    pill.className = 'pill failed';
  }
}

/* ---------- bootstrapping ---------- */
async function bootstrap() {
  await Promise.all([
    fillExamplePatch(),
    fillExampleFull(),
    refreshState(),
    reloadAircraftList(),
    (async () => {
      const res = await fetchJson('/api/headend_ping');
      if (res.json) updateHeadendPill(res);
    })()
  ]);
  renderAircraftState();
}

window.onload = bootstrap;
</script>
</body>
</html>
