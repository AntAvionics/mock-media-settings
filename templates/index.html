<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mock Media Settings — Dashboard</title>
  <style>
    :root {
      --bg:#f6f8fa; --card:#fff; --muted:#6b7280;
      --accent:#2563eb; --mono: ui-monospace, SFMono-Regular, Menlo, Monaco,
      'Roboto Mono', 'Courier New', monospace;
    }
    body {
      margin:0; padding:20px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg); color:#111827;
    }
    .container { max-width:1000px; margin:0 auto; }
    header { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
    h1 { margin:0; font-size:1.25rem; }
    .sub { color:var(--muted); font-size:0.9rem; }

    .grid { display:grid; gap:12px; grid-template-columns: 1fr 380px; }
    .card {
      background:var(--card);
      border:1px solid #e6edf3;
      border-radius:8px;
      padding:12px;
      box-shadow:0 1px 0 rgba(16,24,40,0.02);
    }
    pre {
      background:#0b1220; color:#e6eef8;
      padding:12px; border-radius:6px;
      overflow:auto; font-family:var(--mono);
      font-size:13px; line-height:1.4; max-height:420px;
    }
    label { display:block; margin-top:8px; font-size:0.9rem; }
    textarea, input, select {
      width:100%; box-sizing:border-box;
      font-family:var(--mono); font-size:13px;
      padding:8px; border-radius:6px;
      border:1px solid #e6edf3;
    }
    .btn {
      background:var(--accent); color:white;
      padding:8px 12px; border-radius:6px;
      cursor:pointer; border:none; font-weight:600;
    }
    .btn.secondary { background:#111827; }
    .btn[disabled] { opacity:0.5; cursor:not-allowed; }
    .row { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .small { font-size:0.85rem; color:var(--muted); }
    #state-summary {
      min-height:100px; padding:8px;
      border-radius:6px; border:1px solid #e6edf3;
      background:#f9fafb;
      font-family:var(--mono); font-size:13px;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>Mock Media Settings — Dashboard</h1>
      <div class="sub">
        Forwarding to aircraft:
        <code>{{ aircraft_url }}</code>
      </div>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <div>
      <div class="card">
        <h3>Current State</h3>
        <div id="state-summary">Loading…</div>
        <div class="row">
          <button class="btn" onclick="refreshState()">Refresh</button>
          <button class="btn" onclick="fetchHistory()">Show History</button>
        </div>
        <div id="initial-warning" class="small" style="color:#b91c1c;font-weight:600">
          Initial FULL (v1+) required before PATCH or ROLLBACK.
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Send PATCH</h3>
        <textarea id="patch-json" rows="7"></textarea>
        <div class="row">
          <button class="btn" id="btn-send-patch" onclick="sendPatch()" disabled>
            Send PATCH
          </button>
          <button class="btn secondary" onclick="fillExamplePatch()">Example</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Send FULL snapshot</h3>
        <textarea id="full-json" rows="7"></textarea>
        <div class="row">
          <button class="btn" onclick="sendFull()">Send FULL</button>
          <button class="btn secondary" onclick="fillExampleFull()">Example</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Send ROLLBACK</h3>
        <select id="rollback-target">
          <option value="LVA">LVA — Last Version Active</option>
          <option value="LKG">LKG — Last Known Good</option>
        </select>
        <div class="row">
          <button class="btn" id="btn-send-rollback" onclick="sendRollback()" disabled>
            Send ROLLBACK
          </button>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card">
        <h3>Activity / Response</h3>
        <pre id="activity">Idle</pre>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Diagnostics</h3>
        <div class="row">
          <button class="btn" onclick="pingAircraft()">Ping aircraft</button>
          <button class="btn" onclick="fetchHistory()">Load history</button>
        </div>
        <div id="history-list" style="margin-top:12px"></div>
      </div>
    </div>
  </div>
</div>

<script>
window.onload = function() {
    fillExamplePatch();
    fillExampleFull();
};
async function fetchJson(path, opts) {
  const r = await fetch(path, opts);
  const t = await r.text();
  try { return { ok:r.ok, json:JSON.parse(t), status:r.status }; }
  catch { return { ok:r.ok, text:t, status:r.status }; }
}

function parseAndPrettify(id) {
  const el = document.getElementById(id);
  const obj = JSON.parse(el.value);
  el.value = JSON.stringify(obj, null, 2);
  return obj;
}

function pretty(o) {
  return JSON.stringify(o, null, 2);
}

/* ---------- examples ---------- */
function fillExamplePatch() {
  document.getElementById('patch-json').value = pretty({
    version: 2,
    prev: 1,
    changes: { campaignA_priority: 85 }
  });
}

function fillExampleFull() {
  document.getElementById('full-json').value = pretty({
    version: 1,
    data: {
      campaignA_priority: 70,
      campaignB_routes: []
    }
  });
}

/* ---------- actions ---------- */
async function sendPatch() {
  let obj; try { obj = parseAndPrettify('patch-json'); }
  catch { return alert('Invalid JSON'); }
  const res = await fetchJson('/api/send_patch', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify(obj)
  });
  renderActivity(res); refreshState();
}

async function sendFull() {
  let obj; try { obj = parseAndPrettify('full-json'); }
  catch { return alert('Invalid JSON'); }
  const res = await fetchJson('/api/send_full', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify(obj)
  });
  renderActivity(res); refreshState();
}

async function sendRollback() {
  const target = document.getElementById('rollback-target').value;
  const res = await fetchJson('/api/send_rollback', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ target })
  });
  renderActivity(res); refreshState();
}

/* Helpers to insert examples */
async function fillExamplePatch() {
  const response = await fetch('/static/resource/examplePatch.json');
  const data = await response.json();
  document.getElementById('patch-json').value = JSON.stringify(data, null, 2);
}
async function fillExampleFull() {
  const response = await fetch('static/resource/exampleFull.json');
  const data = await response.json();
  document.getElementById('full-json').value = JSON.stringify(data, null, 2);
}
function fillExampleRollback() {
  document.getElementById('rollback-target').value = 'LVA';
}
async function pingAircraft() {
  const res = await fetchJson('/api/ping');
  renderActivity(res);
}

/* ---------- rendering ---------- */
function renderActivity(res) {
  document.getElementById('activity').textContent =
    res.json ? pretty(res.json) : res.text;
}

function renderStateSummary(state) {
  const s = document.getElementById('state-summary');
  if (!state.history?.length) {
    s.textContent = 'No broadcasts yet.';
    return;
  }
  const h = state.history[0];
  s.textContent =
    `Broadcasts: ${state.history.length}\n` +
    `Last: ${h.type} #${h.id}\nStatus: ${h.status}\nTime: ${h.timestamp}`;
}

function updateControls(state) {
  const hasFull = state.history?.some(h => h.type === 'FULL');
  document.getElementById('btn-send-patch').disabled = !hasFull;
  document.getElementById('btn-send-rollback').disabled = !hasFull;
  document.getElementById('initial-warning').style.display =
    hasFull ? 'none' : 'block';
}

async function fetchHistory() {
  const res = await fetchJson('/api/history');
  if (!res.json) return;
  const list = document.getElementById('history-list');
  list.innerHTML = '';
  res.json.history.forEach(h => {
    const d = document.createElement('div');
    d.textContent = `${h.timestamp} · ${h.type} #${h.id} · ${h.status}`;
    d.style.cursor = 'pointer';
    d.onclick = () => {
      document.getElementById('activity').textContent = pretty(h);
    };
    list.appendChild(d);
  });
}

async function refreshState() {
  const res = await fetchJson('/api/state');
  if (!res.json) return;
  renderStateSummary(res.json);
  updateControls(res.json);
}

fillExamplePatch();
fillExampleFull();
refreshState();
</script>
</body>
</html>
